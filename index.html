<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Gerador Assinatura de E-mail</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
    form { margin-bottom: 20px; }
    input { margin: 5px 0; padding: 8px; width: 250px; }
    #preview { margin-top: 20px; border: 1px solid #ccc; display:none; }
    .buttons { margin-top: 10px; }
    button { display: inline-block; padding: 10px 20px; margin: 5px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; text-decoration: none; background: #00568f; color: white; }
    button:hover { background: #00294f; }
    #csvFile { display: none; }
    .hint { font-size: 12px; color: #444; margin-top: 4px; }
  </style>
</head>
<body>
  <h1>Gerar Assinaturas de E-mail</h1>

  <form id="formulario" onsubmit="return false;">
    <!-- Inputs para ediÃ§Ã£o manual -->
    <input type="text" id="nome" placeholder="Nome"><br>
    <input type="text" id="cargo" placeholder="Cargo"><br>
    <input type="text" id="telefone" placeholder="Telefone"><br>
    <input type="text" id="local" placeholder="Local"><br>
    <input type="email" id="email" placeholder="E-mail"><br>
    <input type="text" id="site" placeholder="Site  ex.: brn.com.br"><br>
    <div class="hint">Dica: vocÃª pode usar apenas os campos acima (1 assinatura) ou importar um CSV (vÃ¡rias assinaturas).</div>

    <!-- Input de arquivo oculto -->
    <input type="file" id="csvFile" accept=".csv">

    <div class="buttons">
      <button type="button" id="btnImport">ðŸ“‚ Importar CSV</button>
      <button type="button" id="btnGerar">âš¡ Gerar Assinaturas</button>
    </div>
  </form>

  <canvas id="preview" width="1541" height="399"></canvas><br>

  <script>
    let linhasCSV = []; // guarda os dados carregados do CSV (sem cabeÃ§alho)

    function detectarDelimitador(text) {
      const primeiraLinha = (text.split(/\r?\n/)[0] || "");
      const pontosEVirgulas = (primeiraLinha.match(/;/g) || []).length;
      const virgulas = (primeiraLinha.match(/,/g) || []).length;
      return pontosEVirgulas > virgulas ? ';' : ',';
    }

    function parseCSV(text) {
      const delimiter = detectarDelimitador(text);
      const linhas = text.replace(/\uFEFF/g, '').split(/\r?\n/).filter(l => l.trim().length > 0);
      const saida = [];
      for (const linha of linhas) {
        saida.push(splitCSVLine(linha, delimiter));
      }
      return { delimiter, rows: saida };
    }

    function splitCSVLine(line, delimiter) {
      const out = [];
      let cur = '';
      let inQuotes = false;
      for (let i = 0; i < line.length; i++) {
        const ch = line[i];
        if (ch === '"') {
          if (inQuotes && line[i+1] === '"') {
            cur += '"';
            i++;
          } else {
            inQuotes = !inQuotes;
          }
        } else if (ch === delimiter && !inQuotes) {
          out.push(cur);
          cur = '';
        } else {
          cur += ch;
        }
      }
      out.push(cur);
      return out.map(v => v.replace(/\r/g,'').trim());
    }

    function dataURLParaBlob(dataURL) {
      const arr = dataURL.split(','), mime = arr[0].match(/:(.*?);/)[1];
      const bstr = atob(arr[1]);
      let n = bstr.length; const u8arr = new Uint8Array(n);
      while (n--) u8arr[n] = bstr.charCodeAt(n);
      return new Blob([u8arr], {type: mime});
    }

    async function gerarImagem(dados) {
      return new Promise((resolve) => {
        const [nome = '', cargo = '', telefone = '', local = '', email = '', site = ''] = dados;
        const canvas = document.getElementById("preview");
        const ctx = canvas.getContext("2d");

        const img = new Image();
        img.src = "https://files.catbox.moe/av3zkt.png"; 
        img.onload = () => {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

          ctx.font = "bold 36px Futura, Arial, sans-serif";
          ctx.fillStyle = "white";
          ctx.fillText(nome, 50, 100);

          ctx.font = "28px 'Futura Bk BT', Arial, sans-serif";
          ctx.fillText(cargo, 290, 143);
          ctx.fillText(telefone, 100, 200);
          ctx.fillText(local, 100, 245);
          ctx.fillText(email, 100, 290);
          ctx.fillText(site, 100, 335);

          const dataURL = canvas.toDataURL("image/png");
          const nomeArquivo = nome ? nome.replace(/\s+/g, "-").toLowerCase() + ".png" : "assinatura.png";
          resolve({ nomeArquivo, dataURL });
        };
        img.onerror = () => {
          alert('NÃ£o foi possÃ­vel carregar o arquivo modelo.png. Verifique se ele estÃ¡ na mesma pasta.');
          resolve(null);
        }
      });
    }

    document.getElementById('btnImport').addEventListener('click', () => {
      document.getElementById('csvFile').click();
    });

    document.getElementById("csvFile").addEventListener("change", function(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        const text = e.target.result.trim();
        const { rows } = parseCSV(text);
        if (rows.length <= 1) {
          alert('CSV sem conteÃºdo. Certifique-se de incluir cabeÃ§alho e dados.');
          linhasCSV = [];
          return;
        }
        linhasCSV = rows.slice(1);
        alert(`CSV carregado com ${linhasCSV.length} registro(s).`);
      };
      reader.readAsText(file, 'utf-8');
    });

    document.getElementById('btnGerar').addEventListener('click', async () => {
      if (linhasCSV.length > 0) {
        const zip = new JSZip();
        for (let i = 0; i < linhasCSV.length; i++) {
          const resultado = await gerarImagem(linhasCSV[i]);
          if (!resultado) continue;
          const { nomeArquivo, dataURL } = resultado;
          zip.file(nomeArquivo, dataURL.split(",")[1], { base64: true });
        }
        const content = await zip.generateAsync({ type: "blob" });
        saveAs(content, "assinaturas.zip");
      } else {
        const dados = [
          document.getElementById('nome').value,
          document.getElementById('cargo').value,
          document.getElementById('telefone').value,
          document.getElementById('local').value,
          document.getElementById('email').value,
          document.getElementById('site').value,
        ];

        if (dados.every(v => !v)) {
          alert('Preencha os campos ou importe um CSV.');
          return;
        }

        const resultado = await gerarImagem(dados);
        if (!resultado) return;
        const { nomeArquivo, dataURL } = resultado;
        const blob = dataURLParaBlob(dataURL);
        saveAs(blob, nomeArquivo);
      }
    });
  </script>
</body>
</html>
